# 开发计划（执行版）

## 1. 目标

1. 保持现有 PWA 主链路稳定（注册/登录/对练/复盘/历史回看）。
2. 在低成本、无需 ICP 的前提下，提升中国大陆用户访问成功率。
3. 以最小风险推进部署迁移：先 `A`，后评估是否进入 `B`。

## 2. 里程碑状态

### M1 安全基线（P0）

状态: 已完成

1. RLS 核心策略落地（`0004`）
2. claim 兼容修复（`0005`）
3. 生产 mock 鉴权保护阈值
4. RLS 隔离自动化校验

### M2 稳定性与可回归（P0）

状态: 已完成（持续补强）

1. 后端自动化测试与 DB 集成测试
2. Supabase JWT 冒烟脚本
3. 发布前一键预检脚本
4. GitHub Actions 手动预检
5. OFNR 离线/在线回归机制

### M3 PWA 产品化（P1）

状态: 已完成（维护优化）

1. Manifest + Service Worker + 安装入口
2. 离线壳与网络状态提示
3. 历史会话离线快照
4. 安装引导与图标体系优化

### M4 部署迁移（P1）

状态: 设计完成，待实施

目标:

1. `方案 A`: Cloudflare 前端 + 现有 Vercel 后端
2. `方案 B`: Cloudflare 前端 + Render 后端（可选增强）
3. 迁移后保持现有功能与测试体系不回退

## 3. M4 任务清单

### 3.1 Phase A（必须）

1. `D1 [P0 | 0.5d]` Cloudflare 项目准备与文档落档
2. `D2 [P0 | 1d]` 前端部署到 Cloudflare Pages（`web/`）
3. `D3 [P0 | 0.5d]` 前端默认 API 地址切到 Vercel API 域名
4. `D4 [P0 | 0.5d]` 后端 CORS 放开 Cloudflare 域名
5. `D5 [P0 | 1d]` A 方案全链路回归（手动 + 脚本）
6. `D6 [P0 | 0.5d]` A 方案发布与回滚预案演练

### 3.2 Phase B（条件触发）

触发条件: A 方案上线后 API 访问仍明显不稳或延迟不可接受。

1. `D7 [P1 | 0.5d]` Render 服务准备（Singapore，Python Web Service）
2. `D8 [P1 | 1d]` Render 后端部署与环境变量迁移
3. `D9 [P1 | 0.5d]` 前端 API 域名切换到 Render
4. `D10 [P1 | 1d]` B 方案全链路回归与压力观测
5. `D11 [P1 | 0.5d]` B 方案灰度与回滚演练（可一键切回 Vercel API）

## 4. 当前优先级待办

1. P0: 执行 Phase A（`D1-D6`）
2. P0: 完成 A 方案上线后的 3-7 天访问稳定性观察
3. P1: 满足触发条件后再进入 Phase B（`D7-D11`）
4. P2: PWA 体验优化（安装转化率与离线可读增强）

## 5. 完成定义（Definition of Done）

每个迁移任务合并前至少满足:

1. 主链路可跑通（注册/登录/对练/总结/复盘/历史）
2. 自动化预检通过（`release_preflight` + `pwa_smoke_check`）
3. 文档同步更新（方案/测试/复盘）
4. 有明确回滚路径（可在 15 分钟内切回前版本）

M4 阶段额外验收:

1. A 方案前端可在 Cloudflare 域名稳定打开
2. API 请求错误率未显著劣化
3. PWA 安装、更新、离线壳能力不回退
4. 若启用 B，Render 切换与回滚都已演练

## 6. 执行顺序（推荐）

1. 阶段一（本周）: `D1 -> D2 -> D3 -> D4`
2. 阶段二（本周）: `D5 -> D6`
3. 阶段三（可选）: 观察指标后决定是否执行 `D7-D11`

## 7. 两周排期（2026-02-23 ~ 2026-03-08）

1. 第 1 周
   - 完成 Phase A 的部署、联调、回归、回滚演练
2. 第 2 周
   - 观察 A 方案效果
   - 决策是否启动 Phase B

## 8. 已确认决策

1. A 方案先仅用 `*.pages.dev` 验证，跑通后再评估 `leonalgo.site`
2. B 方案当前不实施，仅当 A 方案无法满足目标时再触发
3. 当前阶段不讨论 Render 付费实例，待触发 B 时再决策
