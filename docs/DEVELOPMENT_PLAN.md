# 开发计划（执行版）

## 1. 目标

1. 保持现有 PWA 主链路稳定（注册/登录/对练/复盘/历史回看）
2. 在低成本、无需 ICP 的前提下，保证中国大陆移动端可访问可用
3. 持续降低“平台迁移导致功能不可用”的概率

## 2. 里程碑状态

### M1 安全基线（P0）

状态: 已完成

1. RLS 核心策略落地（`0004`）
2. claim 兼容修复（`0005`）
3. 生产 mock 鉴权保护阈值
4. RLS 隔离自动化校验

### M2 稳定性与可回归（P0）

状态: 已完成（持续补强）

1. 后端自动化测试与 DB 集成测试
2. Supabase JWT 冒烟脚本
3. 发布前一键预检脚本
4. GitHub Actions 手动预检
5. OFNR 离线/在线回归机制

### M3 PWA 产品化（P1）

状态: 已完成（维护优化）

1. Manifest + Service Worker + 安装入口
2. 离线壳与网络状态提示
3. 历史会话离线快照
4. 安装引导与图标体系优化

### M4 部署迁移（P1）

状态: `A 已完成并稳定化`，`B 暂不触发`

完成内容:

1. Cloudflare Pages 前端发布稳定
2. Pages Functions 同域 API 代理落地
3. 前端生产强制同域 API
4. SW 缓存策略收敛（不缓存 `app.js`）
5. 迁移后全链路烟测通过

## 3. M4 复盘后任务清单（当前执行）

### 3.1 Phase A-2（稳定化收口，必须）

1. `S1 [P0 | 0.5d]` 发布与回滚 runbook 固化（含故障链路）
2. `S2 [P0 | 0.5d]` 建立迁移后 3-7 天稳定性观察记录模板
3. `S3 [P0 | 0.5d]` 补齐“客户端旧 SW 清理”用户引导文案
4. `S4 [P0 | 0.5d]` 在文档中固化 API 代理验收顺序

### 3.2 Phase A-3（体验优化，建议）

1. `U1 [P1 | 1d]` 新用户安装/注册/首轮练习引导再优化
2. `U2 [P1 | 0.5d]` 常见错误提示精细化（区分离线/鉴权/代理不可达）
3. `U3 [P1 | 0.5d]` 增加“快速自检”入口（静态、代理、登录状态）

### 3.3 Phase B（条件触发）

触发条件: A 方案稳定观察期内，API 连通或延迟持续不可接受。

1. `B1 [P1 | 0.5d]` Render 服务准备（Singapore）
2. `B2 [P1 | 1d]` Render 后端部署与环境迁移
3. `B3 [P1 | 0.5d]` 前端代理目标切换与灰度
4. `B4 [P1 | 1d]` B 方案回归与回滚演练

## 4. 当前优先级待办

1. P0: 完成 `S1-S4` 文档与运行手册收口
2. P0: 完成 3-7 天稳定性观察并记录结论
3. P1: 启动 `U1-U3` 体验增强
4. P1: 保留 B 方案预案，不提前实施

## 5. 完成定义（Definition of Done）

每个迁移/稳定化任务合并前至少满足:

1. 主链路可跑通（注册/登录/对练/总结/复盘/历史）
2. 自动化预检通过（`release_preflight` + `pwa_smoke_check`）
3. 文档同步更新（方案/测试/复盘/计划）
4. 有明确回滚路径（15 分钟内可切回上一稳定版本）

## 6. 执行顺序（推荐）

1. 阶段一: `S1 -> S2 -> S3 -> S4`
2. 阶段二: `U1 -> U2 -> U3`
3. 阶段三: 稳定观察后决定是否触发 `B1-B4`

## 7. 两周排期（2026-02-23 ~ 2026-03-08）

1. 第 1 周
   - 完成 A 方案稳定化收口（S1-S4）
   - 同步完成文档复盘
2. 第 2 周
   - 持续观察线上稳定性
   - 交付一轮 UX 优化（U1-U3）

## 8. 已确认决策

1. A 方案为当前生产基线，不回退到“前端直连后端跨域”模式
2. 生产前端 API 统一同域 `/api/*`
3. B 方案暂不实施，仅在 A 持续不达标时触发
4. 当前阶段不做小程序/原生 App
