# 开发计划（执行版）

## 1. 目标

- 从“可联调”推进到“可小规模真实试用”。
- 保证主链路稳定、安全、可回归。

## 2. 里程碑状态

### M1 安全基线（P0）

状态: 已完成

已完成项:

1. 核心表 RLS 策略落地（`0004`）
2. claim 解析兼容修复（`0005`）
3. 请求级 RLS 上下文注入（role + jwt sub）
4. 生产环境 mock 鉴权保护阈值
5. RLS 隔离自动化校验脚本

### M2 稳定性与可回归（P0）

状态: 已完成（持续补强）

已完成项:

1. 后端 DB 集成测试（`RUN_DB_TESTS` 开关）
2. CI 增加 Postgres service 测试通道
3. Supabase JWT 冒烟脚本
4. 发布前一键预检脚本
5. GitHub Actions 手动预检 workflow
6. 线上预检闭环已打通（RLS + JWT API smoke）
7. OFNR evalset 回归脚本接入预检（阈值门禁）
8. OFNR evalset 扩展到 `v0.2`（30 样本）
9. 在线模型回归模式（`scripts/run_ofnr_eval.py --mode online|both`）

### M3 产品可用性（P1）

状态: 进行中（v1 已落地）

目标:

1. 从联调页过渡到更清晰的练习流程页
2. 降低非技术用户测试门槛
3. 增强错误提示的可理解性和可恢复性

已完成项（2026-02-13）:

1. 前端改为引导式 3 步流程（登录 -> 对练 -> 总结复盘）
2. 会话状态可视化（scene/session/turn）与步骤进度条
3. 会话记录面板（轮次、分数、风险）与 OFNR 反馈展示
4. 行动卡、复盘提交、周进度查询入口整合到同一页
5. 高级配置收敛为 dev-only，线上默认仅暴露必要操作
6. 跨会话历史回看：会话列表与单会话完整回看接口 + 前端入口
7. 历史会话筛选：状态、关键词、日期范围（前后端）
8. 回看体验增强：按轮跳转、关键句提示、活动会话一键继续练习
9. 行动卡可视化增强：生成时间展示、复制、Markdown 导出
10. 复盘结果快照：提交后状态摘要与时间展示
11. 历史回看增强：筛选条件持久化、分页浏览、按风险分组展示
12. 行动卡导出扩展：PDF（打印导出）、PNG 图片、分享模板（复制/导出）

### M4 观测与运维（P1）

状态: 进行中（v0 已落地）

目标:

1. 结构化日志与关键错误聚合
2. 关键指标告警（5xx/慢请求/LLM失败率）
3. 故障排查与回滚手册

已完成项（2026-02-13）:

1. 请求级结构化日志（request_id / route / status / latency / is_slow）
2. 慢请求阈值与计数聚合（`SLOW_REQUEST_MS`）
3. 5xx 错误聚合（最近错误列表）
4. 可观测性快照端点 `GET /ops/metrics`

说明:

1. 按当前产品决策，暂不做外部日志平台/告警通道接入。

## 3. 当前优先级待办

1. P1: 在线模型回归接入发布流程（`RUN_ONLINE_OFNR_EVAL=1` 的灰度门禁策略）
2. P1: 历史回看分组策略优化（支持按状态/风险混合分组）
3. P1: 行动卡模板个性化（按对象角色自动选模板）
4. P2: 复盘数据可视化（趋势图与关键阻碍词聚合）

## 4. 完成定义（Definition of Done）

每个需求合并前至少满足：

1. 功能主路径可手动验证
2. 相关自动化测试通过
3. 文档同步更新（技术方案/部署测试/复盘）
4. 有明确回滚路径或降级策略

## 5. 执行节奏建议（2 周）

1. 第 1 周
   - 在线模型回归灰度接入发布流程
   - 历史列表混合分组策略优化
2. 第 2 周
   - 行动卡模板个性化
   - 复盘趋势可视化
