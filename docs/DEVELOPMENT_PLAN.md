# 开发计划（执行版）

## 1. 目标

- 从“可联调”推进到“可安装、可离线兜底、可持续发布”的 PWA 产品形态。
- 保证主链路稳定、安全、可回归。
- 当前阶段仅聚焦 PWA，微信小程序/安卓/iOS 暂不进入开发。

## 2. 里程碑状态

### M1 安全基线（P0）

状态: 已完成

已完成项:

1. 核心表 RLS 策略落地（`0004`）
2. claim 解析兼容修复（`0005`）
3. 请求级 RLS 上下文注入（role + jwt sub）
4. 生产环境 mock 鉴权保护阈值
5. RLS 隔离自动化校验脚本

### M2 稳定性与可回归（P0）

状态: 已完成（持续补强）

已完成项:

1. 后端 DB 集成测试（`RUN_DB_TESTS` 开关）
2. CI 增加 Postgres service 测试通道
3. Supabase JWT 冒烟脚本
4. 发布前一键预检脚本
5. GitHub Actions 手动预检 workflow
6. 线上预检闭环已打通（RLS + JWT API smoke）
7. OFNR evalset 回归脚本接入预检（阈值门禁）
8. OFNR evalset 扩展到 `v0.2`（30 样本）
9. 在线模型回归模式（`scripts/run_ofnr_eval.py --mode online|both`）

### M3 PWA 产品化（P1）

状态: 已完成（进入维护优化）

目标:

1. 支持浏览器可安装（Installable）
2. 实现基础离线能力（可打开应用壳 + 明确离线提示）
3. 保持在线主链路体验与当前一致

任务清单（T1-T12）:

1. `T1 [P0 | 0.5d]` PWA 基线与开关（`PWA_ENABLED`）
2. `T2 [P0 | 0.5d]` Manifest 与图标资源
3. `T3 [P0 | 1d]` Service Worker 注册与生命周期
4. `T4 [P0 | 1d]` 静态资源缓存策略（cache-first）
5. `T5 [P0 | 1d]` API 请求策略与降级（network-first）
6. `T6 [P1 | 0.5d]` 安装体验（Install Prompt）
7. `T7 [P1 | 0.5d]` 更新体验（新版本提示）
8. `T8 [P1 | 0.5d]` 离线状态与恢复提示
9. `T9 [P1 | 1d]` 最近会话本地快照（离线可读）
10. `T10 [P0 | 1d]` 测试与验收脚本
11. `T11 [P0 | 0.5d]` 部署与回滚策略
12. `T12 [P0 | 0.5d]` 文档同步更新

已完成项（2026-02-15）:

1. `T1` PWA 基线开关（`PWA_ENABLED`，支持 dev 控制）
2. `T2` Manifest 与图标资源
3. `T3` Service Worker 注册与更新切换
4. `T4` 静态资源缓存（`cache-first`）
5. `T5` API 请求离线降级（`network-first` + 503 提示）
6. `T6` 安装入口（Install Prompt）
7. `T7` 更新提示与手动更新按钮
8. `T8` 在线/离线状态提示
9. `T9` 最近会话本地快照（历史列表与单会话离线回看）
10. `T10` PWA 冒烟脚本并接入预检
11. `T11` 发布与回滚策略脚本化（`scripts/vercel_release.sh`）
12. `T12` 文档同步收口（计划/技术/测试/复盘一致）
13. 离线快照容量与清理策略优化（会话上限、TTL、手动清理入口）

### M4 多端扩展准备（P2）

状态: 暂缓（仅保留准备项）

说明:

1. 微信小程序/安卓/iOS 当前不进入开发。
2. 仅保留 API 契约稳定与前端结构可扩展性准备。

## 3. 当前优先级待办（PWA-only）

1. P1: PWA 离线能力增强（静态页与只读会话更丰富）
2. P1: 发布流程自动化（把 `vercel_release` 与预检串成单入口）
3. P2: 微信小程序/原生 App 保持预研，不进入实现

## 4. 完成定义（Definition of Done）

每个任务合并前至少满足：

1. 功能主路径可手动验证
2. 相关自动化测试通过
3. 文档同步更新（技术方案/部署测试/复盘）
4. 有明确回滚路径或降级策略

PWA 阶段额外验收：

1. 浏览器可安装（Manifest 生效）
2. 断网可打开应用壳
3. API 离线错误提示可理解
4. 新版本更新可感知并可切换

## 5. 执行顺序（按推荐方案）

### 5.1 阶段一：PWA 核心能力

顺序:

1. `T1 -> T2 -> T3 -> T4 -> T5 -> T10`

目标:

1. 先打通可安装与离线壳，再补测试兜底

### 5.2 阶段二：PWA 体验增强

顺序:

1. `T6 -> T7 -> T8 -> T9`

目标:

1. 让安装、升级、离线反馈更可用

### 5.3 阶段三：发布收口

顺序:

1. `T11 -> T12`

目标:

1. 完成上线策略与文档闭环

## 6. 两周排期（2026-02-16 ~ 2026-03-01）

1. 第 1 周
   - 完成阶段一（`T1-T5`, `T10`）已完成
2. 第 2 周
   - 完成阶段二（`T6-T9`）已完成
   - 完成阶段三（`T11-T12`）已完成
