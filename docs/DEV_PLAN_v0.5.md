# 开发计划 v0.5（执行版）

## 1. 目标

- 从“可联调”推进到“可小规模真实用户试用”。
- 以真实 Supabase 用户链路为主，补齐安全、稳定性和可用性短板。

## 2. 范围与原则

1. 线上只使用 Supabase 鉴权；Mock 仅本地开发保留。
2. 先做安全与稳定，再做体验增强。
3. 每个里程碑必须带可复现验收脚本或用例。

## 3. 里程碑与验收

### M1 安全基线（P0）

工作项:

1. 实施并验证 Supabase RLS 策略（users/scenes/sessions/messages/feedback 等核心表）。
2. 收敛服务端权限使用，避免业务 API 依赖 service role 执行用户读写。
3. 生产环境关闭 mock 回退（`MOCK_AUTH_ENABLED=false`）。

验收标准:

1. A 用户 token 无法读取/写入 B 用户数据。
2. RLS 误放行/误拒绝场景均有测试覆盖。
3. 线上配置审计通过并记录到文档。

当前进展（2026-02-12）:

1. 已新增 `0004_enable_rls_core_tables.sql`（策略草案已落库脚本化）。
2. 已新增 `0005_fix_request_user_id_claim_resolution.sql`（修复 claim 解析兼容性）。
3. 已在后端请求链路注入 DB RLS 上下文（role + jwt sub claim）。
4. 已加入生产环境 mock 安全阈值校验（默认禁止）。
5. 已新增 `scripts/rls_isolation_check.sh` 作为隔离验收脚本。
6. 待完成: 在目标 Supabase 环境执行 `0004/0005` 并做隔离回归验收。

### M2 稳定性与可回归（P0）

工作项:

1. 增加后端集成测试（真实 JWT + 主链路 `scenes -> sessions -> messages`）。
2. 为关键接口补充超时、重试和错误分级策略（特别是 LLM 调用）。
3. CI 增加“迁移 + 集成测试”流水线。

验收标准:

1. 一键回归可在 CI 复现主链路成功。
2. 常见故障有清晰错误码和可读提示。
3. 变更后可以在 10 分钟内完成冒烟验证。

当前进展（2026-02-12）:

1. 已新增 DB 集成测试 `test_api_flow_integration.py`（默认按 `RUN_DB_TESTS` 开关执行）。
2. 已在 CI 增加 Postgres service + 集成测试通道。
3. 已新增 `scripts/supabase_jwt_api_smoke_test.sh` 作为 JWT 端到端回归脚本。
4. 待完成: 将 JWT 回归脚本并入发布前 checklist。

### M3 产品可用性（P1）

工作项:

1. 前端从联调面板改成“引导式 3 步练习流”（减少配置暴露）。
2. 增加历史会话与反馈可视化（OFNR 分项趋势、改写采纳记录）。
3. 增加最小用户管理能力（当前登录用户信息展示、登出、会话恢复）。

验收标准:

1. 新用户无需理解技术配置也可完成一轮完整练习。
2. 用户可追溯最近会话与反馈结果。
3. 错误反馈可被普通用户理解并恢复操作。

### M4 观测与运维（P1）

工作项:

1. 增加请求 ID 全链路追踪与结构化日志。
2. 配置基础错误告警（API 5xx、LLM 调用失败率、慢请求）。
3. 补充运行手册（故障排查、回滚、紧急降级）。

验收标准:

1. 关键故障可在 5 分钟内定位到模块。
2. 有清晰的回滚和降级指引。

## 4. 近期 2 周执行清单（建议）

1. 第 1 周
   - 完成 RLS SQL 草案 + 验证脚本
   - 补 Supabase JWT 集成测试
   - 固化线上环境变量审计清单
2. 第 2 周
   - 上线引导式练习页 v1
   - 增加会话历史与反馈列表
   - 接入基础日志与错误告警

## 5. 需你确认的决策点

1. RLS 先覆盖哪些表（建议先核心 5 表: users/scenes/sessions/messages/feedback_items）。
2. 前端 v1 是否优先“移动端”交互优化。
3. 观测方案是否先用 Vercel/Supabase 原生能力，后续再接第三方平台。
4. 是否允许我在下一轮直接推进 M1 的 Supabase 隔离验收脚本（A/B 用户交叉访问自动校验）。
