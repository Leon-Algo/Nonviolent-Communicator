# 阶段复盘（整合）

## 1. 复盘范围

- 时间范围: 2026-02-11 至 2026-02-12
- 覆盖阶段: 从 MVP 首版联调到安全与回归基线落地

## 2. 时间线摘要

### 2026-02-11

关键进展:

1. 核心 API 链路可运行（场景/会话/消息/改写/总结/复盘/进度）
2. 前后端完成 Vercel 部署并可在线联调
3. 修复核心稳定性问题:
   - Pooler prepared statement 冲突
   - SQL 参数歧义
   - 模型响应结构容错

### 2026-02-12

关键进展:

1. 鉴权主链路收敛为 Supabase JWT（线上）
2. `auth.users -> public.users` 自动同步迁移落地（`0003`）
3. 核心表 RLS 与 claim 兼容修复落地（`0004`, `0005`）
4. 增加自动化验证资产:
   - DB 集成测试
   - RLS 隔离校验脚本
   - Supabase JWT 冒烟脚本
   - 发布前一键预检脚本
   - GitHub 手动预检 workflow

### 2026-02-13

关键进展:

1. 前端从“联调台”重构为“引导式 3 步练习流”
2. 登录、会话、反馈、行动卡、复盘、周进度统一在单页流程内串联
3. 线上默认隐藏高级配置，仅在 dev 场景开放 mock 与调试项
4. 增加会话记录和步骤状态可视化，降低测试认知成本

## 3. 关键问题与根因

1. 前端 `Failed to fetch`
   - 原因: 跨域/配置与历史状态混合导致请求路径不稳定。
2. 消息接口 500
   - 原因: DB 连接与 SQL 参数处理在特定路径下不稳定。
3. Supabase 注册 429
   - 原因: Auth 邮件发送频控触发。
4. mock token 与 supabase mode 混用报 401
   - 原因: 鉴权模式与 token 类型不匹配。

## 4. 本阶段关键决策

1. 线上仅开放 Supabase 鉴权入口，隐藏 mock 入口。
2. mock 仅用于本地开发联调，并加生产环境保护开关。
3. 发布前必须执行自动化预检，至少覆盖单测与 RLS 校验。

## 5. 验证结果（已通过）

1. 后端测试: `pytest backend/tests -q`（17 passed, 2 skipped）
2. 语法校验: `node --check web/app.js`、`bash -n` 脚本校验
3. RLS 隔离: `bash scripts/rls_isolation_check.sh` 通过
4. 一键预检: `SKIP_REMOTE_API_SMOKE=1 bash scripts/release_preflight.sh` 通过
5. M3 页面交互链路已完成本地回归（登录、练习、总结复盘入口可达）

说明:

- 远端 API 冒烟在部分执行环境可能受网络限制，建议在 GitHub Actions 或本机可达网络补跑。

## 6. 当前状态结论

项目已从“可设计”进入“可运行、可回归、具备安全基线”的阶段，可继续推进产品可用性与观测能力建设。

## 7. 下一阶段重点

1. 前端练习流程产品化（降低测试复杂度）
2. 会话历史与进度可视化
3. 最小可观测性（日志、关键告警）
